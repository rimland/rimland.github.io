---
layout: post
title:  "Asp.Net Core 5 REST API - Step by Step"
date:   2021-04-03 00:10:09 +0800
categories: dotnet csharp
published: true
---

> 翻译自 Mohamad Lawand 2021年1月19日的文章 [《Asp.Net Core 5 Rest API Step by Step》](https://dev.to/moe23/asp-net-core-5-rest-api-step-by-step-2mb6) [^1]

[^1]: <https://dev.to/moe23/asp-net-core-5-rest-api-step-by-step-2mb6> Asp.Net Core 5 Rest API Step by Step

<!-- In this post we will be creating a simple Asp.Net Core Rest API Todo application where we will be able to add, edit, delete and view todo items and we will be utilising SQLite to store our data. -->

在本文中，我们将创建一个简单的 Asp.Net Core REST API Todo 应用程序，在其中我们可以添加、编辑、删除和查看待办事项，并且将使用 SQLite 来存储数据。

你也可以在 YouTube 上[观看完整的视频](https://youtu.be/p_wUdWshYc8)[^video]，还可以[下载源代码](https://github.com/mohamadlawand087/v6-RestApiNetCore5)[^source]。

[^video]: <https://youtu.be/p_wUdWshYc8>

[^source]: <https://github.com/mohamadlawand087/v6-RestApiNetCore5>

<!-- This is Part 1 of API dev series: -->

这是 API 开发系列的第一部分，后面还有：

- Part 2：[Asp.Net Core 5 REST API 使用 JWT 身份验证 - Step by Step](https://dev.to/moe23/asp-net-core-5-rest-api-authentication-with-jwt-step-by-step-140d)
- Part 3：[Asp Net Core 5 REST API 中使用 RefreshToken 刷新 JWT - Step by Step](https://dev.to/moe23/refresh-jwt-with-refresh-tokens-in-asp-net-core-5-rest-api-step-by-step-3en5)

![Asp.Net Core 5 REST API](/assets/images/202104/2y624yffje41tclunrjo.png)

在开始之前，我们需要准备的四样东西：

- Visual Studio code (<https://code.visualstudio.com/>)
- Dotnet core SDK (<https://dotnet.microsoft.com/download>)
- Postman (<https://www.postman.com/downloads/>)
- DBeaver (<https://dbeaver.io/download/>)

<!-- Once we have downloaded and installed all of the required tool, we need to make sure that the dotnet SDK has been installed successfully, we need to open the terminal and check if the dotnet SDK is installed successfully by checking the dotnet version -->

下载并安装了所有必需的工具后，我们需要确保 dotnet SDK 已成功安装，我们需要打开终端并通过检查 dotnet 版本来检查 dotnet SDK 是否已成功安装。

打开终端，输入以下命令：

```bash
dotnet --version
```

<!-- Now we need to install the entity framework tool -->

现在，我们需要安装 EntityFramework 工具：

```bash
dotnet tool install --global dotnet-ef
```

<!-- Once thats finish we need to create our application -->

完成后，我们需要创建我们的应用程序：

```bash
dotnet new webapi -n "TodoApp" -lang "C#" -au none
```

<!-- Now lets add the packages that we will nee in order of us to utilise the EntityFramrwork and SQLite -->

现在让我们添加需要使用的包，以便可以使用 EntityFramrwork 和 SQLite：

```bash
dotnet add package Microsoft.EntityFrameworkCore.Sqlite
dotnet add package Microsoft.EntityFrameworkCore.Tools
```

<!-- Now lets open VS code and check our application and check the source code, lets build the application and see if its running -->

现在，请打开 VS Code 并检查我们的应用程序和源代码，然后，让我们构建应用程序并查看其是否可以运行：

```bash
dotnet build
dotnet run
```

<!-- We start by removing the default template code that was generated by the .Net core framework for us. Will dlete the WeatherForcastController and the WeatherForcast class. -->

首先，我们删除由 .Net Core 框架为我们生成的默认模板代码，即删除 `WeatherForcastController` `和WeatherForcast` 类。

接着，我们创建自己的控制器，将其命名为 `TodoController`。

<!-- Will create our first simple action will call it TestRun, lets start coding our controller -->

然后，我们创建第一个简单的 `Action`，将其命名为 `TestRun`，让我们开始为我们的控制器编码：

```csharp
[Route("api/[controller]")] // 我们定义控制器要使用的路由
[ApiController] // 我们需要指定控制器的类型以让 .Net core 知道
public class TodoController : ControllerBase
{
    [Route("TestRun")] // 定义此 Action 的路由
    [HttpGet]
    public ActionResult TestRun()
    {
        return Ok("success");
    }
}
```

<!-- Once we finish adding we need to test it, in order for us to do that we need to do the following -->

创建完成后，我们需要对其进行测试，为了测试，我们需要执行以下操作：

```bash
dotnet build
dotnet run
```

<!-- Once the application is running we need to open postman and try it there see we get the response. -->

应用程序运行起来后，我们可以打开 Postman 试一下看看我们获得的响应。

<!-- we create a new request in postman and set the type to get and we add the following URL: -->

我们在 Postman 中创建一个新请求，并将类型设置为 `GET`，然后请求以下 URL：

```text
https://localhost:5001/api/todo/testrun
```

正如您在 TestRun 中看到的那样，我们在 Postman 中得到了 “success” 响应。

<!-- After testing it we now need to start adding models, we add a models folder in the root directory and we add a class inside of it called Item. This is going to be a very simple model which represent our todo list item. -->

测试完之后，我们现在需要开始添加模型，我们在根目录中添加一个 *Models* 文件夹，并在其中添加一个名为 `ItemData` 的类。这是一个非常简单的模型，它表示我们的待办事项的列表项。

```csharp
public class ItemData
{
    public int Id { get; set; }
    public string Title { get; set; }
    public string Description { get; set; }
    public bool Done { get; set; }
}
```

<!-- once we add our model now we need to build our ApiDbContext. We need to create a Data folder in our root directory and inside this folder will create a new class called ApiDbContext. -->

添加好模型后，我们需要构建 `ApiDbContext`。在根目录中创建一个 *Data* 文件夹，然后在该文件夹中创建一个名为 `ApiDbContext` 的新类。

```csharp
public class ApiDbContext : DbContext
{
    public virtual DbSet<ItemData> Items {get;set;}

    public ApiDbContext(DbContextOptions<ApiDbContext> options)
        : base(options)
    {
        
    }
}
```

<!-- We need to specify our connection string inside the appsetting.json application -->

然后，我们需要在 `appsetting.json` 中指定连接字符串：

```json
"ConnectionStrings": {
  "DefaultConnection" : "DataSource=app.db; Cache=Shared"
}
```

<!-- Perfect once our DbContext and connection string is ready we need to update the startup class so we can utilise the Application DbContext inside our application. Open the startup class in our root folder and add the following code. -->

完善 DbContext 和连接字符串后，我们需要更新 `Startup` 类，以便可以在应用程序中使用 Application DbContext。在我们的根目录中打开 `Startup` 类，然后添加以下代码：

```csharp
services.AddDbContext<ApiDbContext>(options =>
    options.UseSqlite(
        Configuration.GetConnectionString("DefaultConnection")
    ));
```

<!-- Once we have add the DbContext middleware we need to add the initial migration to create the database. -->

添加好 DbContext 中间件后，我们需要添加初始化迁移来创建数据库。

```bash
dotnet ef migrations add "Initial Migrations"
dotnet ef database update
```

<!-- After the database update has completed successfully we can see we have a new folder called migrations which will contain the C# script which will be responsible on creating the database and its table Item. we can verify that the database has been created since we can see the app.db file in our root directory as well we can see that use the SQLite browser to verify that the table has been created successfully. -->

成功完成数据库更新后，我们可以看到有一个名为 *Migrations* 的新文件夹，它将包含 C# 脚本，该脚本将负责创建数据库及其表 `Items`。我们可以在根目录中看到 *app.db* 文件，也可以使用 SQLite 查看工具来验证表是否已成功创建，由此我们可以验证数据库是否已创建。

<!-- Now that we have completed all of the infrastructure work for our controller. Now we need to start building our TodoController and connect it to the ApiDbContext. -->

现在，我们已经完成了控制器的所有基础设施的搭建。现在，我们需要开始构建 `TodoController` 并将其连接到`ApiDbContext`。

<!-- Will start by adding the get all items in our todo list -->

我们从添加获取待办事项中的所有项的方法 `GetItems` 开始，依次添加所有需要的方法：

```csharp
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using TodoApp.Data;
using TodoApp.Models;

namespace TodoApp.Controllers
{
    [Route("api/[controller]")] // api/todo
    [ApiController]
    public class TodoController : ControllerBase
    {
        private readonly ApiDbContext _context;

        public TodoController(ApiDbContext context)
        {
            _context = context;
        }

        [HttpGet]
        public async Task<IActionResult> GetItems()
        {
            var items = await _context.Items.ToListAsync();
            return Ok(items);
        }

        [HttpPost]
        public async Task<IActionResult> CreateItem(ItemData data)
        {
            if (ModelState.IsValid)
            {
                await _context.Items.AddAsync(data);
                await _context.SaveChangesAsync();

                return CreatedAtAction("GetItem", new { data.Id }, data);
            }

            return new JsonResult("Something went wrong") { StatusCode = 500 };
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetItem(int id)
        {
            var item = await _context.Items.FirstOrDefaultAsync(x => x.Id == id);

            if (item == null)
                return NotFound();

            return Ok(item);
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateItem(int id, ItemData item)
        {
            if (id != item.Id)
                return BadRequest();

            var existItem = await _context.Items.FirstOrDefaultAsync(x => x.Id == id);

            if (existItem == null)
                return NotFound();

            existItem.Title = item.Title;
            existItem.Description = item.Description;
            existItem.Done = item.Done;

            // Implement the changes on the database level
            await _context.SaveChangesAsync();

            return NoContent();
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteItem(int id)
        {
            var existItem = await _context.Items.FirstOrDefaultAsync(x => x.Id == id);

            if (existItem == null)
                return NotFound();

            _context.Items.Remove(existItem);
            await _context.SaveChangesAsync();

            return Ok(existItem);
        }
    }
}
```

<!-- We can test each one of these in postman. -->

然后，我们可以在 Postman 中一个一个地对它们进行测试。

<!-- Finally since we are using .Net 5 when creating webapi project Swagger will be already integrated within our application, in order for us to see the swagger interface we need to go to -->

最后，由于我们在创建 Web API 项目时使用的是 .Net 5，因此 Swagger 已经集成到了我们的应用程序中，要查看 Swagger 界面，可以在浏览器中导航到 <http://localhost:5000/swagger/index.html>。

<!-- Swagger allows you to describe the structure of your APIs so that machines can read them, at no extra work from our side other then defining swagger in older version of .net core swagger will be able to read our API structure and give us a UI that we can use to enhance our dev experience -->

Swagger 允许您描述 API 的结构，以便程序可以自动读取它们，而无需我们额外的工作。Swagger 能够读取 API 结构并为我们生成一个 UI，我们可以借此来改善开发体验。

感谢您阅读本文。

本文是 API 开发系列的第一部分，后面会有第二、第三部分。

<br />

> 作者 ： Mohamad Lawand  
> 译者 ： 技术译民  
> 出品 ： [技术译站](https://ittranslator.cn/)  
> 链接 ： [英文原文](https://dev.to/moe23/asp-net-core-5-rest-api-step-by-step-2mb6)
